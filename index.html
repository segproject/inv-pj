<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üì¶ INV-PJ</title>
  <!-- Librer√≠as externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --color-fondo: #fafbfd;
      --color-card: white;
      --color-primary: #4CAF50;
      --color-secondary: #607d8b;
      --color-texto: #333;
      --color-texto-secundario: #666;
      --borde-radius: 8px;
      --sombra: 0 2px 8px rgba(0,0,0,0.06);
      --btn-padding: 8px 12px;
      --btn-font-size: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--color-fondo);
      color: var(--color-texto);
      line-height: 1.5;
      font-size: 14px;
      padding: 12px;
    }
    .navbar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .navbar button {
      background: var(--color-secondary);
      color: white;
      border: none;
      padding: var(--btn-padding);
      border-radius: var(--borde-radius);
      cursor: pointer;
      font-weight: 600;
      font-size: var(--btn-font-size);
      min-width: 100px;
      transition: all 0.2s ease;
    }
    .navbar button:hover { opacity: 0.9; }
    .navbar button.active {
      background: var(--color-primary);
      box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      background: var(--color-card);
      border-radius: var(--borde-radius);
      box-shadow: var(--sombra);
      display: none;
    }
    .active-view { display: block !important; }
    h2 {
      margin-bottom: 12px;
      font-size: 1.4rem;
      font-weight: 700;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 8px;
      font-weight: 600;
      font-size: 13px;
    }
    select, input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      padding: var(--btn-padding);
      margin-top: 8px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: var(--btn-font-size);
      min-height: 36px;
      transition: all 0.2s ease;
    }
    button:hover { background: #45a049; }
    button.secondary { background: #9e9e9e; }
    button.danger { background: #f44336; }
    button.impulsar { background: #ff9800; }
    button.export { background: #2196F3; }
    .tabla-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 12px;
      border-radius: var(--borde-radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background-color: #f8faf8;
      font-weight: 600;
      color: var(--color-secondary);
      font-size: 12px;
      position: sticky;
      top: 0;
    }
    .acciones button {
      padding: 4px 8px;
      margin: 0 2px;
      font-size: 16px;
      min-width: 32px;
      min-height: 32px;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    .form-section {
      background: #f0f5f0;
      padding: 16px;
      border-radius: var(--borde-radius);
      margin-bottom: 16px;
      border: 1px solid #dfe8df;
    }
    .form-group {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px dashed #aaa;
    }
    .form-group:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    .form-group-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--color-secondary);
    }
    .autocomplete {
      position: relative;
      width: 100%;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #ddd;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      border-radius: 0 0 4px 4px;
      background: white;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    .autocomplete-item:hover,
    .autocomplete-item.highlight {
      background: #e8f5e9;
    }
    .item-categoria {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
    .almacenes-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .almacenes-buttons button {
      margin-top: 0;
      padding: 6px 12px;
      font-size: 13px;
      min-height: auto;
      width: auto;
      flex: 1;
      max-width: 150px;
      border-radius: 4px;
    }
    .mensaje-vacio {
      text-align: center;
      color: var(--color-texto-secundario);
      padding: 16px;
      font-style: italic;
      font-size: 14px;
    }
    .cal-dia-vertical {
      position: relative;
      font-size: 13px;
      min-height: 60px;
      padding: 8px;
      border-radius: 4px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 8px;
      border: 1px solid #eee;
    }
    .cal-dia-vertical .cal-evento {
      background: rgba(76, 175, 80, 0.12);
      color: #2e7d32;
      padding: 2px 4px;
      margin: 2px 0;
      border-radius: 2px;
      font-size: 11px;
      display: block;
      word-break: break-word;
    }
    .cal-dia-vertical.cal-dia-hoy {
      border: 2px solid #4CAF50;
      font-weight: bold;
    }
    /* Modal de edici√≥n */
    #modalFormulario {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #modalFormulario .modal-content {
      background: white;
      width: 95%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 16px;
      max-height: 90vh;
      overflow-y: auto;
    }
    @media (max-width: 768px) {
      .ocultar-movil {
        display: none;
      }
      .navbar button {
        padding: 6px 8px;
        font-size: 12px;
        min-width: 80px;
      }
      .cal-dia-vertical {
        min-height: 50px;
        padding: 6px;
      }
    }
  </style>
</head>
<body>
<div class="navbar">
  <button onclick="cambiarVista('calendario')" id="btnCalendario">üìÖ Calendario</button>
  <button onclick="cambiarVista('inventario')" id="btnInventario">üì¶ Inventario</button>
  <button onclick="cambiarVista('impulsados')" id="btnImpulsados">üéØ Por Impulsar</button>
  <button onclick="cambiarVista('configuraciones')" id="btnConfig">‚öôÔ∏è Configuraci√≥n</button>
</div>

<!-- === INVENTARIO === -->
<div id="vistaInventario" class="container">
  <h2 id="tituloForm">Registrar Insumo</h2>
  <div class="form-section" id="formSection">
    <form id="formulario">
      <input type="hidden" id="registroId" />
      <!-- SECCI√ìN 1: DATOS DEL INSUMO -->
      <div class="form-group">
        <div class="form-group-title">1. Datos del insumo</div>
        <label for="categoria">Categor√≠a</label>
        <select id="categoria">
          <option value="">-- Todas las categor√≠as --</option>
          <option value="C√ÅRNICOS EN TROZOS Y RODAJAS">C√°rnicos</option>
          <option value="QUESOS">Quesos</option>
          <option value="FRUTAS Y VEGETALES">Frutas y Vegetales</option>
          <option value="SALSAS">Salsas</option>
          <option value="OTROS INSUMOS">Otros Insumos</option>
          <option value="PREPS">Preparaciones (PREPS)</option>
          <option value="OTRO">Otro (escribir)</option>
        </select>
        <label for="busquedaGlobal">Insumo</label>
        <div class="autocomplete">
          <input type="text" id="busquedaGlobal" placeholder="Escriba para buscar..." autocomplete="off" />
          <div class="autocomplete-items" id="listaAutocompletado"></div>
        </div>
        <input type="text" id="insumoInput" placeholder="Nombre del insumo" style="display:none; margin-top:8px;" />
      </div>
      <!-- SECCI√ìN 2: GESTI√ìN OPERATIVA -->
      <div class="form-group">
        <div class="form-group-title">2. Gesti√≥n operativa</div>
        <label for="etapa">Etapa</label>
        <select id="etapa" required>
          <option value="">-- Seleccionar --</option>
          <option value="RECIBIDO">Recibido</option>
          <option value="PREPARADO">Preparado</option>
          <option value="LINEA">En L√≠nea</option>
        </select>
        <label for="almacenamiento">Almacenamiento</label>
        <select id="almacenamiento"></select>
        <label for="fechaIngreso">F. Ingreso</label>
        <input type="date" id="fechaIngreso" />
        <label for="fechaVencimientoManual">F. Venc. Manual (si aplica)</label>
        <input type="date" id="fechaVencimientoManual" />
      </div>
      <!-- SECCI√ìN 3: CANTIDAD Y UNIDAD -->
      <div class="form-group">
        <div class="form-group-title">3. Cantidad y unidad</div>
        <label for="cantidad">Cant.</label>
        <input type="number" id="cantidad" min="0.1" step="0.1" required />
        <label for="unidad">U/M</label>
        <select id="unidad" required></select>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button type="button" onclick="guardarRegistro()">Guardar</button>
        <button type="button" onclick="limpiarFormularioCompleto()">Limpiar</button>
        <button type="button" onclick="cancelarEdicion()" id="btnCancelar" class="secondary" style="display:none;">Cancelar</button>
      </div>
    </form>
  </div>
  <div class="form-section">
    <div class="almacenes-buttons" id="botonesAlmacenes"></div>
  </div>
  <div style="margin: 12px 0; display:flex; gap:8px; flex-wrap:wrap;">
    <button onclick="exportarPDF('inventario')" class="export">üìÑ PDF</button>
    <button onclick="exportarExcel('inventario')" class="export">xlsx</button>
  </div>
  <div class="tabla-wrapper">
    <table id="tablaInventario">
      <thead>
        <tr>
          <th>Insumo</th>
          <th class="ocultar-movil">Etapa</th>
          <th class="ocultar-movil">F. Ingreso</th>
          <th>F. Venc.</th>
          <th>Cant.</th>
          <th>U/M</th>
          <th class="ocultar-movil">Almac.</th>
          <th>D√≠as Rest.</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>
  </div>
</div>

<!-- === MODAL DE EDICI√ìN === -->
<div id="modalFormulario">
  <div class="modal-content">
    <h3 style="text-align:center; margin-bottom:12px;">‚úèÔ∏è Editar Insumo</h3>
    <form id="formularioModal">
      <input type="hidden" id="registroIdModal" />
      <!-- SECCI√ìN 1: DATOS DEL INSUMO -->
      <div class="form-group">
        <div class="form-group-title">1. Datos del insumo</div>
        <label for="categoriaModal">Categor√≠a</label>
        <select id="categoriaModal">
          <option value="">-- Todas las categor√≠as --</option>
          <option value="C√ÅRNICOS EN TROZOS Y RODAJAS">C√°rnicos</option>
          <option value="QUESOS">Quesos</option>
          <option value="FRUTAS Y VEGETALES">Frutas y Vegetales</option>
          <option value="SALSAS">Salsas</option>
          <option value="OTROS INSUMOS">Otros Insumos</option>
          <option value="PREPS">Preparaciones (PREPS)</option>
          <option value="OTRO">Otro (escribir)</option>
        </select>
        <label for="busquedaGlobalModal">Insumo</label>
        <div class="autocomplete">
          <input type="text" id="busquedaGlobalModal" placeholder="Escriba para buscar..." autocomplete="off" />
          <div class="autocomplete-items" id="listaAutocompletadoModal"></div>
        </div>
        <input type="text" id="insumoInputModal" placeholder="Nombre del insumo" style="display:none; margin-top:8px;" />
      </div>
      <!-- SECCI√ìN 2: GESTI√ìN OPERATIVA -->
      <div class="form-group">
        <div class="form-group-title">2. Gesti√≥n operativa</div>
        <label for="etapaModal">Etapa</label>
        <select id="etapaModal" required>
          <option value="">-- Seleccionar --</option>
          <option value="RECIBIDO">Recibido</option>
          <option value="PREPARADO">Preparado</option>
          <option value="LINEA">En L√≠nea</option>
        </select>
        <label for="almacenamientoModal">Almacenamiento</label>
        <select id="almacenamientoModal"></select>
        <label for="fechaIngresoModal">F. Ingreso</label>
        <input type="date" id="fechaIngresoModal" />
        <label for="fechaVencimientoManualModal">F. Venc. Manual (si aplica)</label>
        <input type="date" id="fechaVencimientoManualModal" />
      </div>
      <!-- SECCI√ìN 3: CANTIDAD Y UNIDAD -->
      <div class="form-group">
        <div class="form-group-title">3. Cantidad y unidad</div>
        <label for="cantidadModal">Cant.</label>
        <input type="number" id="cantidadModal" min="0.1" step="0.1" required />
        <label for="unidadModal">U/M</label>
        <select id="unidadModal" required></select>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 12px; justify-content: center;">
        <button type="button" onclick="guardarDesdeModal()">Guardar</button>
        <button type="button" onclick="cerrarModal()" class="secondary">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- === VISTAS RESTANTES === -->
<div id="vistaImpulsados" class="container">
  <h2>üéØ Por Impulsar</h2>
  <div style="margin: 12px 0; display:flex; gap:8px; flex-wrap:wrap;">
    <button onclick="exportarPDF('impulsados')" class="export">üìÑ PDF</button>
    <button onclick="exportarExcel('impulsados')" class="export">xlsx</button>
  </div>
  <div class="tabla-wrapper">
    <table id="tablaImpulsados">
      <thead>
        <tr>
          <th>Insumo</th>
          <th>F. Venc.</th>
          <th>Cant.</th>
          <th>U/M</th>
          <th class="ocultar-movil">Almac.</th>
          <th>D√≠as Rest.</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpoTablaImpulsados"></tbody>
    </table>
  </div>
  <div id="mensajeVacioImpulsados" class="mensaje-vacio" style="display:none;">
    No hay insumos marcados para impulsar.
  </div>
</div>

<div id="vistaCalendario" class="container">
  <h2>üìÖ Calendario de Vencimientos</h2>
  <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px;">
    <button onclick="cambiarSemana(-1)" class="secondary">‚ùÆ Semana</button>
    <span id="tituloSemana" style="margin: 0 10px; font-weight: 600; font-size: 14px;"></span>
    <button onclick="cambiarSemana(1)" class="secondary">Semana ‚ùØ</button>
  </div>
  <div id="calendarioVertical"></div>
</div>

<div id="vistaConfiguraciones" class="container">
  <h2>‚öôÔ∏è Configuraciones</h2>
  <div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap;">
    <button onclick="exportarRespaldo()" class="export">üíæ Exportar Respaldo (.json)</button>
    <button onclick="document.getElementById('archivoRespaldo').click()" class="secondary">üì• Importar Respaldo (.json)</button>
    <input type="file" id="archivoRespaldo" accept=".json" style="display:none;" onchange="importarRespaldo(event)" />
  </div>
  <div class="config-section">
    <h3>Unidades de Medida</h3>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <input type="text" id="nuevaUnidad" placeholder="Ej: caja, bandeja..." style="flex:1;" />
      <button type="button" onclick="agregarUnidad()" style="margin-top:0; padding:6px 12px; font-size:13px;">Agregar</button>
    </div>
    <div id="listaUnidades" style="margin-top:12px;"></div>
  </div>
  <div class="config-section">
    <h3>Lugares de Almacenamiento</h3>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <input type="text" id="nuevoAlmacen" placeholder="Ej: Congelador 1..." style="flex:1;" />
      <button type="button" onclick="agregarAlmacenamiento()" style="margin-top:0; padding:6px 12px; font-size:13px;">Agregar</button>
    </div>
    <div id="listaAlmacenamientos" style="margin-top:12px;"></div>
  </div>
  <div class="config-section">
    <h3>Columnas visibles en inventario</h3>
    <div id="columnasCheckboxes" style="margin-top:12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px;"></div>
    <button onclick="guardarConfiguracionColumnas()" style="margin-top:12px; padding:6px 12px; font-size:13px;">üíæ Guardar configuraci√≥n</button>
  </div>
</div>

<script>
  const { jsPDF } = window.jspdf;
  // === BASE DE DATOS FIJA (DATA MOD) ===
  const db = {
    "C√ÅRNICOS EN TROZOS Y RODAJAS": {
      "Alitas de pollo - local": { RECIBIDO: 7, PREPARADO: 7, LINEA: 1 },
      "Poppers de pollo": { RECIBIDO: 7, PREPARADO: 7, LINEA: 1 },
      "Pollo asado - importado": { RECIBIDO: 10, PREPARADO: 7, LINEA: 1 },
      "Salchicha italiana": { RECIBIDO: 12, PREPARADO: 7, LINEA: 1 },
      "Chorizo - local": { RECIBIDO: 7, PREPARADO: 4, LINEA: 1 },
      "Chorizo Parrillero": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 6, LINEA: 1 },
      "Carne de res - local": { RECIBIDO: 12, PREPARADO: 7, LINEA: 2 },
      "Salchicha de cerdo": { RECIBIDO: 12, PREPARADO: 7, LINEA: 2 },
      "Tocino": { RECIBIDO: 30, PREPARADO: 7, LINEA: 2 },
      "Pepperoni de cerdo": { RECIBIDO: 30, PREPARADO: 7, LINEA: 2 },
      "Jam√≥n - local": { RECIBIDO: 14, PREPARADO: 7, LINEA: 2 }
    },
    "QUESOS": {
      "Queso Mozzarella": { RECIBIDO: 14, PREPARADO: 7, LINEA: 1 },
      "Queso en tiras": { RECIBIDO: 14, PREPARADO: 7, LINEA: 1 },
      "Mezcla de 3 quesos (Asiago, Fontina, Provolone)": { RECIBIDO: 7, PREPARADO: 7, LINEA: 1 },
      "Mezcla de 2 quesos (Romano y Parmesano)": { RECIBIDO: 7, PREPARADO: 7, LINEA: 1 }
    },
    "FRUTAS Y VEGETALES": {
      "Champi√±√≥n": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 1, LINEA: "11:59 p. m." },
      "Cebolla blanca/roja": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 2, LINEA: "11:59 p. m." },
      "Pimiento rojo": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 2, LINEA: "11:59 p. m." },
      "Pimiento verde": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 2, LINEA: "11:59 p. m." },
      "Tomate": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 2, LINEA: "11:59 p. m." },
      "Jalape√±os": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 60, LINEA: "11:59 p. m." },
      "Aceituna negra": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: 2 },
      "Aceituna verde": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: 2 },
      "Pi√±a - lata": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 15, LINEA: 2 },
      "Pepperoncini": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 15, LINEA: "11:59 p. m." }
    },
    "SALSAS": {
      "Salsa pizza - lata": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "10 horas", LINEA: "10 horas" },
      "Salsa de mayonesa con aj√≠ limo": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa rosada (1kg)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa rosada (0.5 kg)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa Parrillera": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 3, LINEA: "11:59 p. m." },
      "Salsa de ajo (botella - granel)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 21, LINEA: "11:59 p. m." },
      "Salsa de mango habanero (bolsa)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa Ranch": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa Bechamel": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Salsa Chimichurri": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 15, LINEA: 2 },
      "Salsa de ajo (blister - cup)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "11:59 p. m." },
      "Salsa Parmesana (botella - granel)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 21, LINEA: "11:59 p. m." },
      "Salsa BBQ (blister - cup)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Salsa BBQ (bolsa)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 4, LINEA: 2 },
      "Salsa Buffalo (blister - cup)": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Salsa de Miel Picante": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." }
    },
    "OTROS INSUMOS": {
      "Dustinator": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 14, LINEA: 2 },
      "Masa Croisant": { RECIBIDO: 5, PREPARADO: null, LINEA: "11:59 p. m." },
      "Masa delgada - importada": { RECIBIDO: 30, PREPARADO: 3, LINEA: null },
      "Az√∫car glaseada (Icing) - local": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 30, LINEA: 2 },
      "Cinamon Spreed": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 30, LINEA: 2 },
      "Or√©gano - sachet": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Aji panca - sachet": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Or√©gano - granel": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Aji panca - granel": { RECIBIDO: "Seg√∫n empaque", PREPARADO: "Seg√∫n empaque", LINEA: "Seg√∫n empaque" },
      "Sazonador italiano": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: 3 },
      "Pasta de lasagna": { RECIBIDO: 10, PREPARADO: 8, LINEA: null },
      "Tortilla": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 7, LINEA: "11:59 p. m." },
      "Manjar Blanco": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 15, LINEA: 5 },
      "Az√∫car Impalpable": { RECIBIDO: "Seg√∫n empaque", PREPARADO: 30, LINEA: 5 }
    },
    "PREPS": {
      "Lasagna (All the meats/The Works/Americana)": { RECIBIDO: null, PREPARADO: 4, LINEA: null },
      "Rollitos de Pepperoni/Jam√≥n": { RECIBIDO: null, PREPARADO: "6 horas", LINEA: "6 horas" },
      "Rollitos de Manjar": { RECIBIDO: null, PREPARADO: "6 horas", LINEA: "6 horas" },
      "Rollitos de Canela": { RECIBIDO: null, PREPARADO: "6 horas", LINEA: "6 horas" }
    }
  };
  const indiceGlobal = [];
  for (const categoria in db) {
    for (const insumo in db[categoria]) {
      indiceGlobal.push({ insumo, categoria });
    }
  }

  // === FUNCIONES DE EXPORTACI√ìN (OMITIDAS POR ESPACIO, PERO LAS CONSERVA) ===
  function exportarPDF(tipo) {
    const titulo = tipo === 'inventario' ? 'Inventario de Insumos' : 'Insumos por Impulsar';
    const columnas = tipo === 'inventario'
      ? ["Insumo", "Etapa", "F. Ingreso", "F. Venc.", "Cant.", "U/M", "Almac.", "D√≠as Rest."]
      : ["Insumo", "F. Venc.", "Cant.", "U/M", "Almac.", "D√≠as Rest."];
    const datos = [];
    const filtrar = tipo === 'inventario' ? inventario : inventario.filter(i => i.impulsado);
    const filas = [...filtrar].sort((a, b) => {
      const fechaA = a.fechaVencimiento || new Date(8640000000000000);
      const fechaB = b.fechaVencimiento || new Date(8640000000000000);
      return fechaA - fechaB;
    });
    filas.forEach(item => {
      if (tipo === 'inventario') {
        datos.push([
          item.insumo,
          { RECIBIDO: "Recibido", PREPARADO: "Preparado", LINEA: "En L√≠nea" }[item.etapa] || item.etapa,
          formatearFecha(item.fechaIngreso),
          formatearFecha(item.fechaVencimiento),
          item.cantidad,
          item.unidad,
          item.almacenamiento,
          calcularEstadoYDias(item).diasRestantes ?? "Empaque"
        ]);
      } else {
        datos.push([
          item.insumo,
          formatearFecha(item.fechaVencimiento),
          item.cantidad,
          item.unidad,
          item.almacenamiento,
          calcularEstadoYDias(item).diasRestantes ?? "Empaque"
        ]);
      }
    });
    const doc = new jsPDF('landscape');
    doc.setFontSize(16);
    doc.text(titulo, 15, 15);
    doc.autoTable({
      startY: 20,
      head: [columnas],
      body: datos,
      theme: 'grid',
      headStyles: { fillColor: [76, 175, 80] },
      styles: { fontSize: 10, cellPadding: 3 }
    });
    doc.save(`${titulo.replace(/\s+/g, '_')}.pdf`);
  }
  function exportarExcel(tipo) {
    const elementId = tipo === 'inventario' ? 'tablaInventario' : 'tablaImpulsados';
    const table = document.getElementById(elementId).cloneNode(true);
    const acciones = table.querySelectorAll('td:last-child, th:last-child');
    acciones.forEach(c => c.remove());
    const ws = XLSX.utils.table_to_sheet(table);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Insumos");
    XLSX.writeFile(wb, `${tipo === 'inventario' ? 'Inventario' : 'Por_Impulsar'}.xlsx`);
  }
  function exportarRespaldo() {
    const data = {
      inventario: JSON.parse(localStorage.getItem("inventario")) || [],
      unidades: JSON.parse(localStorage.getItem("unidades")) || ["kg", "g", "unid", "lt", "ml", "paquete", "lata", "bolsa"],
      almacenes: JSON.parse(localStorage.getItem("almacenes")) || ["Congelador", "Refrigerado", "Seco", "En l√≠nea"],
      columnasVisibles: JSON.parse(localStorage.getItem("columnasVisibles")) || {
        insumo: true,
        etapa: true,
        fechaIngreso: true,
        fechaVencimiento: true,
        cantidad: true,
        unidad: true,
        almacenamiento: true,
        diasRestantes: true,
        acciones: true
      }
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `respaldo_vida_util_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  function importarRespaldo(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        localStorage.setItem("inventario", JSON.stringify(data.inventario || []));
        localStorage.setItem("unidades", JSON.stringify(data.unidades || ["kg", "g", "unid", "lt", "ml", "paquete", "lata", "bolsa"]));
        localStorage.setItem("almacenes", JSON.stringify(data.almacenes || ["Congelador", "Refrigerado", "Seco", "En l√≠nea"]));
        localStorage.setItem("columnasVisibles", JSON.stringify(data.columnasVisibles || {}));
        alert("Respaldo importado correctamente. La p√°gina se recargar√°.");
        location.reload();
      } catch (err) {
        alert("Error al importar el archivo. Aseg√∫rese de que sea un respaldo v√°lido.");
      }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  // === AUTOCOMPLETADO GLOBAL ===
  let insumoSeleccionado = null;
  let categoriaSeleccionada = null;
  function initAutocompletado() {
    const input = document.getElementById("busquedaGlobal");
    const lista = document.getElementById("listaAutocompletado");
    const selectCategoria = document.getElementById("categoria");
    input.addEventListener("input", () => {
      const query = input.value.trim().toLowerCase();
      const filtroCat = selectCategoria.value;
      lista.innerHTML = '';
      if (!query) return;
      let coincidencias = indiceGlobal.filter(item =>
        item.insumo.toLowerCase().includes(query)
      );
      if (filtroCat && filtroCat !== "OTRO" && filtroCat !== "") {
        coincidencias = coincidencias.filter(item => item.categoria === filtroCat);
      }
      coincidencias = coincidencias.slice(0, 15);
      coincidencias.forEach(item => {
        const div = document.createElement("div");
        div.classList.add("autocomplete-item");
        div.innerHTML = `<div>${item.insumo}</div><div class="item-categoria">${item.categoria}</div>`;
        div.addEventListener("click", () => {
          input.value = item.insumo;
          insumoSeleccionado = item.insumo;
          categoriaSeleccionada = item.categoria;
          selectCategoria.value = item.categoria;
          document.getElementById("insumoInput").style.display = "none";
          lista.innerHTML = '';
          verificarMostrarFechaManual();
        });
        lista.appendChild(div);
      });
      if (coincidencias.length === 0) {
        const div = document.createElement("div");
        div.classList.add("autocomplete-item");
        div.textContent = "No encontrado. ¬øCrear manualmente?";
        div.style.fontStyle = "italic";
        div.addEventListener("click", () => {
          input.value = "";
          insumoSeleccionado = null;
          categoriaSeleccionada = "OTRO";
          selectCategoria.value = "OTRO";
          document.getElementById("insumoInput").style.display = "block";
          document.getElementById("insumoInput").focus();
          lista.innerHTML = '';
        });
        lista.appendChild(div);
      }
    });
    document.addEventListener("click", (e) => {
      if (!input.contains(e.target) && !lista.contains(e.target)) {
        lista.innerHTML = '';
      }
    });
  }

  function getInsumoValue() {
    return categoriaSeleccionada === "OTRO"
      ? document.getElementById("insumoInput").value.trim()
      : insumoSeleccionado;
  }
  function getCategoriaValue() {
    return categoriaSeleccionada || document.getElementById("categoria").value || "OTRO";
  }

  // === FUNCIONES PRINCIPALES ===
  function cargarConfiguraciones() {
    const unidades = JSON.parse(localStorage.getItem("unidades")) || ["kg", "g", "unid", "lt", "ml", "paquete", "lata", "bolsa"];
    const almacenes = JSON.parse(localStorage.getItem("almacenes")) || ["Congelador", "Refrigerado", "Seco", "En l√≠nea"];
    const columnasVisibles = JSON.parse(localStorage.getItem("columnasVisibles")) || {
      insumo: true,
      etapa: true,
      fechaIngreso: true,
      fechaVencimiento: true,
      cantidad: true,
      unidad: true,
      almacenamiento: true,
      diasRestantes: true,
      acciones: true
    };
    localStorage.setItem("unidades", JSON.stringify(unidades));
    localStorage.setItem("almacenes", JSON.stringify(almacenes));
    localStorage.setItem("columnasVisibles", JSON.stringify(columnasVisibles));
    return { unidades, almacenes, columnasVisibles };
  }
  let config = cargarConfiguraciones();
  let inventario = JSON.parse(localStorage.getItem("inventario")) || [];
  let modoEdicion = false;

  function formatearFecha(fecha) {
    if (!fecha) return "N/A";
    if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
      const [y, m, d] = fecha.split('-');
      return `${d}/${m}/${y}`;
    }
    if (fecha instanceof Date && !isNaN(fecha.getTime())) {
      const day = String(fecha.getDate()).padStart(2, '0');
      const month = String(fecha.getMonth() + 1).padStart(2, '0');
      const year = fecha.getFullYear();
      return `${day}/${month}/${year}`;
    }
    return "N/A";
  }

  // === CALENDARIO ===
  let fechaInicioSemana = new Date();
  fechaInicioSemana.setHours(0, 0, 0, 0);
  const diaHoy = fechaInicioSemana.getDay();
  const ajusteALunes = diaHoy === 0 ? -6 : 1 - diaHoy;
  fechaInicioSemana.setDate(fechaInicioSemana.getDate() + ajusteALunes);

  function obtenerRangoSemana(fechaLunes) {
    const inicio = new Date(fechaLunes);
    const fin = new Date(fechaLunes);
    fin.setDate(fin.getDate() + 6);
    const opts = { day: 'numeric', month: 'short' };
    const inicioStr = inicio.toLocaleDateString('es-PE', opts);
    const finStr = fin.toLocaleDateString('es-PE', opts);
    const anio = inicio.getFullYear();
    return `${inicioStr} ‚Äì ${finStr} ${anio}`;
  }

  function renderizarCalendario() {
    const titulo = document.getElementById("tituloSemana");
    titulo.textContent = obtenerRangoSemana(fechaInicioSemana);
    const porFecha = {};
    inventario.forEach(item => {
      if (item.fechaVencimiento && typeof item.fechaVencimiento === 'string') {
        const key = item.fechaVencimiento;
        if (!porFecha[key]) porFecha[key] = [];
        porFecha[key].push(item);
      }
    });
    const container = document.getElementById("calendarioVertical");
    container.innerHTML = "";
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    for (let i = 0; i < 7; i++) {
      const fecha = new Date(fechaInicioSemana);
      fecha.setDate(fechaInicioSemana.getDate() + i);
      const esHoy = fecha.toDateString() === hoy.toDateString();
      const fechaKey = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
      const tieneEventos = porFecha[fechaKey] && porFecha[fechaKey].length > 0;
      let eventosHtml = '';
      if (tieneEventos) {
        porFecha[fechaKey].forEach(item => {
          eventosHtml += `<div class="cal-evento" title="${item.insumo}">${item.insumo}</div>`;
        });
      }
      const estiloFondo = tieneEventos ? 'background: #f5f9f5;' : '';
      const diaCompleto = fecha.toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'long' });
      const diaElement = document.createElement('div');
      diaElement.className = `cal-dia-vertical ${esHoy ? 'cal-dia-hoy' : ''}`;
      diaElement.style.cssText = `${estiloFondo} padding: 8px; border-radius: 4px; background: white;`;
      diaElement.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 4px; font-size:13px;">${diaCompleto}</div>
        ${eventosHtml || '<div style="color: #999; font-style: italic; font-size:11px;">Sin vencimientos</div>'}
      `;
      container.appendChild(diaElement);
    }
  }

  function cambiarSemana(delta) {
    const dias = delta * 7;
    fechaInicioSemana.setDate(fechaInicioSemana.getDate() + dias);
    renderizarCalendario();
  }

  // === FUNCI√ìN aux: calcular estado y d√≠as restantes ===
  function calcularEstadoYDias(item) {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    let estado = "empaque";
    let diasRestantes = null;
    if (item.fechaVencimiento && typeof item.fechaVencimiento === 'string') {
      const [y, m, d] = item.fechaVencimiento.split('-').map(Number);
      const fechaV = new Date(y, m - 1, d);
      if (!isNaN(fechaV.getTime())) {
        const diffTime = fechaV.getTime() - hoy.getTime();
        diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diasRestantes > 0) estado = "ok";
        else if (diasRestantes === 0) estado = "hoy";
        else estado = "vencido";
      }
    }
    return { estado, diasRestantes };
  }

  // === FUNCI√ìN para cargar selects en el modal ===
  function cargarSelectsConfigModal() {
    const selUnidad = document.getElementById("unidadModal");
    const selAlmacen = document.getElementById("almacenamientoModal");
    selUnidad.innerHTML = '<option value="">-- Seleccionar --</option>';
    selAlmacen.innerHTML = '<option value="">-- Seleccionar --</option>';
    config.unidades.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      selUnidad.appendChild(opt);
    });
    config.almacenes.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      selAlmacen.appendChild(opt);
    });
  }

  function verificarMostrarFechaManualModal() {
    const cat = document.getElementById("categoriaModal").value;
    const insumo = cat === "OTRO" ? document.getElementById("insumoInputModal").value.trim() : document.getElementById("busquedaGlobalModal").value.trim();
    const etapa = document.getElementById("etapaModal").value;
    let mostrar = false;
    if (cat === "OTRO") {
      mostrar = true;
    } else if (cat && insumo && etapa && db[cat] && db[cat][insumo]) {
      const vidaUtil = db[cat][insumo][etapa];
      if (vidaUtil === "Seg√∫n empaque" || vidaUtil === null || vidaUtil === undefined) {
        mostrar = true;
      }
    }
    document.getElementById("fechaVencimientoManualModal").style.display = mostrar ? "block" : "none";
  }

  function calcularFechaVencimiento(categoria, insumo, etapa, fechaIngresoStr, fechaManualStr) {
    if (fechaManualStr) {
      const [a, m, d] = fechaManualStr.split('-').map(Number);
      return new Date(a, m - 1, d);
    }
    if (categoria === "OTRO") return null;
    if (!db[categoria] || !db[categoria][insumo]) return null;
    const info = db[categoria][insumo];
    const vidaUtil = info[etapa];
    if (!vidaUtil || vidaUtil === "Seg√∫n empaque") return null;
    if (typeof vidaUtil === "string" && vidaUtil.includes("horas")) {
      const horas = parseInt(vidaUtil);
      const [a, m, d] = fechaIngresoStr.split('-').map(Number);
      const fecha = new Date(a, m - 1, d);
      fecha.setHours(fecha.getHours() + horas);
      return fecha;
    } else if (vidaUtil === "11:59 p. m.") {
      const [a, m, d] = fechaIngresoStr.split('-').map(Number);
      const fecha = new Date(a, m - 1, d);
      fecha.setHours(23, 59, 0, 0);
      return fecha;
    } else {
      const dias = parseInt(vidaUtil);
      const [a, m, d] = fechaIngresoStr.split('-').map(Number);
      const fecha = new Date(a, m - 1, d);
      fecha.setDate(fecha.getDate() + dias);
      return fecha;
    }
  }

  // === MODAL: guardar desde modal ===
  function guardarDesdeModal() {
    const id = document.getElementById("registroIdModal").value;
    const cat = document.getElementById("categoriaModal").value === "OTRO"
      ? "OTRO"
      : document.getElementById("categoriaModal").value;
    const insumo = cat === "OTRO"
      ? document.getElementById("insumoInputModal").value.trim()
      : document.getElementById("busquedaGlobalModal").value.trim();
    const etapa = document.getElementById("etapaModal").value;
    const almacenamiento = document.getElementById("almacenamientoModal").value || "-";
    const fechaIngreso = document.getElementById("fechaIngresoModal").value;
    const fechaManual = document.getElementById("fechaVencimientoManualModal").value;
    const cantidad = parseFloat(document.getElementById("cantidadModal").value);
    const unidad = document.getElementById("unidadModal").value;

    if (!cat || !insumo || !etapa || !cantidad || !unidad) {
      alert("Complete todos los campos obligatorios.");
      return;
    }

    let fechaIngresoObligatoria = true;
    if (cat !== "OTRO" && etapa === "RECIBIDO" && db[cat] && db[cat][insumo]) {
      const vidaUtil = db[cat][insumo]["RECIBIDO"];
      if (vidaUtil === "Seg√∫n empaque") {
        fechaIngresoObligatoria = false;
      }
    }
    if (fechaIngresoObligatoria && !fechaIngreso) {
      alert("Debe ingresar la fecha de ingreso.");
      return;
    }

    const fechaVencimientoObj = calcularFechaVencimiento(cat, insumo, etapa, fechaIngreso, fechaManual);
    const fechaIngresoStr = fechaIngreso || null;
    const fechaVencimientoStr = fechaVencimientoObj
      ? `${fechaVencimientoObj.getFullYear()}-${String(fechaVencimientoObj.getMonth() + 1).padStart(2, '0')}-${String(fechaVencimientoObj.getDate()).padStart(2, '0')}`
      : null;

    const registro = {
      id: parseInt(id),
      categoria: cat,
      insumo,
      etapa,
      almacenamiento,
      fechaIngreso: fechaIngresoStr,
      fechaVencimiento: fechaVencimientoStr,
      cantidad,
      unidad,
      fechaVencimientoManual: fechaManual || null,
      impulsado: inventario.find(i => i.id == id)?.impulsado || false
    };

    const index = inventario.findIndex(item => item.id == id);
    if (index !== -1) inventario[index] = registro;
    localStorage.setItem("inventario", JSON.stringify(inventario));
    renderizarVistas();
    cerrarModal();
  }

  // === MODAL: cerrar ===
  function cerrarModal() {
    document.getElementById("modalFormulario").style.display = "none";
  }

  // === NUEVA FUNCI√ìN EDITAR CON MODAL ===
  function editarRegistro(id) {
    const item = inventario.find(i => i.id == id);
    if (!item) return;

    cargarSelectsConfigModal();
    document.getElementById("modalFormulario").style.display = "flex";

    document.getElementById("registroIdModal").value = item.id;
    if (item.categoria === "OTRO") {
      document.getElementById("categoriaModal").value = "OTRO";
      document.getElementById("busquedaGlobalModal").value = "";
      document.getElementById("insumoInputModal").style.display = "block";
      document.getElementById("insumoInputModal").value = item.insumo;
    } else {
      document.getElementById("categoriaModal").value = item.categoria;
      document.getElementById("busquedaGlobalModal").value = item.insumo;
      document.getElementById("insumoInputModal").style.display = "none";
    }

    document.getElementById("etapaModal").value = item.etapa;
    document.getElementById("almacenamientoModal").value = item.almacenamiento;
    document.getElementById("fechaIngresoModal").value = item.fechaIngreso || "";
    document.getElementById("fechaVencimientoManualModal").value = item.fechaVencimientoManual || "";
    document.getElementById("cantidadModal").value = item.cantidad;
    document.getElementById("unidadModal").value = item.unidad;

    verificarMostrarFechaManualModal();
  }

  // === FUNCIONES RESTANTES (SIN CAMBIOS) ===
  function cargarSelectsConfig() {
    const selUnidad = document.getElementById("unidad");
    const selAlmacen = document.getElementById("almacenamiento");
    selUnidad.innerHTML = '<option value="">-- Seleccionar --</option>';
    selAlmacen.innerHTML = '<option value="">-- Seleccionar --</option>';
    config.unidades.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      selUnidad.appendChild(opt);
    });
    config.almacenes.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a;
      opt.textContent = a;
      selAlmacen.appendChild(opt);
    });
  }
  function renderizarBotonesAlmacenes() {
    const contenedor = document.getElementById("botonesAlmacenes");
    contenedor.innerHTML = `<button class="secondary" onclick="filtrarPorAlmacen(null)">Mostrar todos</button>`;
    config.almacenes.forEach(almacen => {
      const btn = document.createElement("button");
      btn.textContent = almacen;
      btn.onclick = () => filtrarPorAlmacen(almacen);
      contenedor.appendChild(btn);
    });
  }
  let almacenFiltrado = null;
  function filtrarPorAlmacen(almacen) {
    almacenFiltrado = almacen;
    aplicarFiltros();
  }
  document.getElementById("categoria").addEventListener("change", function () {
    const cat = this.value;
    if (cat === "OTRO") {
      document.getElementById("busquedaGlobal").value = "";
      document.getElementById("insumoInput").style.display = "block";
      insumoSeleccionado = null;
      categoriaSeleccionada = "OTRO";
    } else {
      document.getElementById("insumoInput").style.display = "none";
    }
    verificarMostrarFechaManual();
  });
  document.getElementById("etapa").addEventListener("change", verificarMostrarFechaManual);
  function verificarMostrarFechaManual() {
    const cat = getCategoriaValue();
    const insumo = getInsumoValue();
    const etapa = document.getElementById("etapa").value;
    let mostrar = false;
    if (cat === "OTRO") {
      mostrar = true;
    } else if (cat && insumo && etapa && db[cat] && db[cat][insumo]) {
      const vidaUtil = db[cat][insumo][etapa];
      if (vidaUtil === "Seg√∫n empaque" || vidaUtil === null || vidaUtil === undefined) {
        mostrar = true;
      }
    }
    document.getElementById("fechaVencimientoManual").style.display = mostrar ? "block" : "none";
  }
  function limpiarFormularioCompleto() {
    document.getElementById("formulario").reset();
    document.getElementById("registroId").value = "";
    insumoSeleccionado = null;
    categoriaSeleccionada = null;
    document.getElementById("tituloForm").textContent = "Registrar Insumo";
    document.getElementById("formSection").classList.remove("modo-edicion");
    document.getElementById("btnCancelar").style.display = "none";
    document.getElementById("busquedaGlobal").value = "";
    document.getElementById("insumoInput").style.display = "none";
    document.getElementById("fechaVencimientoManual").style.display = "none";
    cargarSelectsConfig();
  }
  function guardarRegistro() {
    const id = document.getElementById("registroId").value;
    const cat = getCategoriaValue();
    const insumo = getInsumoValue();
    const etapa = document.getElementById("etapa").value;
    const almacenamiento = document.getElementById("almacenamiento").value || "-";
    const fechaIngreso = document.getElementById("fechaIngreso").value;
    const fechaManual = document.getElementById("fechaVencimientoManual").value;
    const cantidad = parseFloat(document.getElementById("cantidad").value);
    const unidad = document.getElementById("unidad").value;
    if (!cat || !insumo || !etapa || !cantidad || !unidad) {
      alert("Complete todos los campos obligatorios.");
      return;
    }
    let fechaIngresoObligatoria = true;
    if (cat !== "OTRO" && etapa === "RECIBIDO" && db[cat] && db[cat][insumo]) {
      const vidaUtil = db[cat][insumo]["RECIBIDO"];
      if (vidaUtil === "Seg√∫n empaque") {
        fechaIngresoObligatoria = false;
      }
    }
    if (fechaIngresoObligatoria && !fechaIngreso) {
      alert("Debe ingresar la fecha de ingreso.");
      return;
    }
    const fechaVencimientoObj = calcularFechaVencimiento(cat, insumo, etapa, fechaIngreso, fechaManual);
    const fechaIngresoStr = fechaIngreso || null;
    const fechaVencimientoStr = fechaVencimientoObj
      ? `${fechaVencimientoObj.getFullYear()}-${String(fechaVencimientoObj.getMonth() + 1).padStart(2, '0')}-${String(fechaVencimientoObj.getDate()).padStart(2, '0')}`
      : null;
    const registro = {
      id: modoEdicion && id ? parseInt(id) : Date.now(),
      categoria: cat,
      insumo,
      etapa,
      almacenamiento,
      fechaIngreso: fechaIngresoStr,
      fechaVencimiento: fechaVencimientoStr,
      cantidad,
      unidad,
      fechaVencimientoManual: fechaManual || null,
      impulsado: false
    };
    if (modoEdicion && id) {
      const index = inventario.findIndex(item => item.id == id);
      if (index !== -1) inventario[index] = registro;
    } else {
      inventario.push(registro);
    }
    localStorage.setItem("inventario", JSON.stringify(inventario));
    renderizarVistas();
    limpiarFormularioCompleto();
  }
  function cancelarEdicion() {
    limpiarFormularioCompleto();
  }
  function eliminarRegistro(id) {
    if (confirm("¬øEliminar este registro?")) {
      inventario = inventario.filter(item => item.id !== id);
      localStorage.setItem("inventario", JSON.stringify(inventario));
      renderizarVistas();
      limpiarFormularioCompleto();
    }
  }
  function impulsarInsumo(id) {
    const item = inventario.find(i => i.id == id);
    if (!item) return;
    item.impulsado = true;
    localStorage.setItem("inventario", JSON.stringify(inventario));
    renderizarTabla();
    renderizarTablaImpulsados();
    cambiarVista('impulsados');
  }
  function quitarDeImpulsados(id) {
    const item = inventario.find(i => i.id == id);
    if (item) {
      item.impulsado = false;
      localStorage.setItem("inventario", JSON.stringify(inventario));
      renderizarTablaImpulsados();
      renderizarTabla();
    }
  }
  function aplicarFiltros() {
    let filtrados = inventario;
    if (almacenFiltrado) {
      filtrados = inventario.filter(item => item.almacenamiento === almacenFiltrado);
    }
    renderizarTabla(filtrados);
  }
  function renderizarTabla(filtrados = null) {
    const data = filtrados !== null ? filtrados : inventario;
    const ordenados = [...data].sort((a, b) => {
      const fechaA = a.fechaVencimiento || "9999-12-31";
      const fechaB = b.fechaVencimiento || "9999-12-31";
      return fechaA.localeCompare(fechaB);
    });
    const tbody = document.getElementById("cuerpoTabla");
    tbody.innerHTML = "";
    ordenados.forEach(item => {
      let fechaVencimientoStr = "N/A";
      let claseEstado = "";
      let etiquetaManual = "";
      if (item.fechaVencimiento) {
        fechaVencimientoStr = formatearFecha(item.fechaVencimiento);
        if (item.fechaVencimientoManual) {
          etiquetaManual = ' <span class="manual-tag">üìÖ</span>';
        }
        const { estado } = calcularEstadoYDias(item);
        claseEstado = estado;
      }
      const etapaTexto = { RECIBIDO: "Recibido", PREPARADO: "Preparado", LINEA: "En L√≠nea" }[item.etapa] || item.etapa;
      const { diasRestantes } = calcularEstadoYDias(item);
      const diasTexto = diasRestantes !== null ? diasRestantes : "Empaque";
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${item.insumo}${item.impulsado ? ' <span style="color:#ff9800; font-size:12px;">üöÄ</span>' : ''}</td>
        <td class="ocultar-movil">${etapaTexto}</td>
        <td class="ocultar-movil">${formatearFecha(item.fechaIngreso)}</td>
        <td style="background-color: #fff8e1; font-weight: bold;">${fechaVencimientoStr}${etiquetaManual}</td>
        <td>${item.cantidad}</td>
        <td>${item.unidad}</td>
        <td class="ocultar-movil">${item.almacenamiento}</td>
        <td class="${claseEstado}">${diasTexto}</td>
        <td class="acciones">
          <button onclick="editarRegistro(${item.id})" title="Editar">‚úèÔ∏è</button>
          <button onclick="eliminarRegistro(${item.id})" class="danger" title="Eliminar">üóëÔ∏è</button>
          <button onclick="impulsarInsumo(${item.id})" class="impulsar" title="Impulsar">üöÄ</button>
        </td>
      `;
      tbody.appendChild(fila);
    });
    actualizarVisibilidadColumnas();
  }
  function renderizarTablaImpulsados() {
    const tbody = document.getElementById("cuerpoTablaImpulsados");
    const mensaje = document.getElementById("mensajeVacioImpulsados");
    tbody.innerHTML = "";
    let impulsados = inventario.filter(item => item.impulsado);
    impulsados = [...impulsados].sort((a, b) => {
      const fechaA = a.fechaVencimiento || "9999-12-31";
      const fechaB = b.fechaVencimiento || "9999-12-31";
      return fechaA.localeCompare(fechaB);
    });
    if (impulsados.length === 0) {
      mensaje.style.display = "block";
      return;
    }
    mensaje.style.display = "none";
    impulsados.forEach(item => {
      let fechaVencimientoStr = "N/A";
      let claseEstado = "";
      let etiquetaManual = "";
      if (item.fechaVencimiento) {
        fechaVencimientoStr = formatearFecha(item.fechaVencimiento);
        if (item.fechaVencimientoManual) {
          etiquetaManual = ' <span class="manual-tag">üìÖ</span>';
        }
        const { estado } = calcularEstadoYDias(item);
        claseEstado = estado;
      }
      const { diasRestantes } = calcularEstadoYDias(item);
      const diasTexto = diasRestantes !== null ? diasRestantes : "Empaque";
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td>${item.insumo}</td>
        <td style="background-color: #fff8e1; font-weight: bold;">${fechaVencimientoStr}${etiquetaManual}</td>
        <td>${item.cantidad}</td>
        <td>${item.unidad}</td>
        <td class="ocultar-movil">${item.almacenamiento}</td>
        <td class="${claseEstado}">${diasTexto}</td>
        <td class="acciones">
          <button onclick="quitarDeImpulsados(${item.id})" class="secondary" title="Quitar">‚Ü©Ô∏è</button>
        </td>
      `;
      tbody.appendChild(fila);
    });
  }
  function renderizarConfiguracionColumnas() {
    const contenedor = document.getElementById("columnasCheckboxes");
    contenedor.innerHTML = "";
    const columnas = [
      { key: "insumo", label: "Insumo" },
      { key: "etapa", label: "Etapa" },
      { key: "fechaIngreso", label: "F. Ingreso" },
      { key: "fechaVencimiento", label: "F. Venc." },
      { key: "cantidad", label: "Cant." },
      { key: "unidad", label: "U/M" },
      { key: "almacenamiento", label: "Almac." },
      { key: "diasRestantes", label: "D√≠as Rest." },
      { key: "acciones", label: "Acciones" }
    ];
    columnas.forEach(col => {
      const div = document.createElement("div");
      div.innerHTML = `
        <label>
          <input type="checkbox" id="col_${col.key}" ${config.columnasVisibles[col.key] ? 'checked' : ''}>
          ${col.label}
        </label>
      `;
      contenedor.appendChild(div);
    });
  }
  function guardarConfiguracionColumnas() {
    const nuevas = {};
    [
      "insumo", "etapa", "fechaIngreso", "fechaVencimiento",
      "cantidad", "unidad", "almacenamiento", "diasRestantes", "acciones"
    ].forEach(key => {
      nuevas[key] = document.getElementById(`col_${key}`).checked;
    });
    config.columnasVisibles = nuevas;
    localStorage.setItem("columnasVisibles", JSON.stringify(nuevas));
    alert("Configuraci√≥n guardada.");
    actualizarVisibilidadColumnas();
  }
  function actualizarVisibilidadColumnas() {
    const col = config.columnasVisibles;
    const ths = document.querySelectorAll("#tablaInventario th");
    const tds = document.querySelectorAll("#tablaInventario td");
    const visibilidad = [
      col.insumo,
      col.etapa,
      col.fechaIngreso,
      col.fechaVencimiento,
      col.cantidad,
      col.unidad,
      col.almacenamiento,
      col.diasRestantes,
      col.acciones
    ];
    ths.forEach((th, i) => {
      th.style.display = visibilidad[i] ? "table-cell" : "none";
    });
    const filas = document.querySelectorAll("#tablaInventario tbody tr");
    filas.forEach(fila => {
      const celdas = fila.querySelectorAll("td");
      celdas.forEach((td, i) => {
        td.style.display = visibilidad[i] ? "table-cell" : "none";
      });
    });
  }
  function renderizarConfiguraciones() {
    renderizarConfiguracionColumnas();
    const listaU = document.getElementById("listaUnidades");
    listaU.innerHTML = "";
    config.unidades.forEach((u, i) => {
      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";
      div.style.padding = "4px 0";
      div.innerHTML = `<span>${u}</span><button onclick="eliminarUnidad(${i})" class="danger" style="padding:2px 6px; font-size:12px;">Eliminar</button>`;
      listaU.appendChild(div);
    });
    const listaA = document.getElementById("listaAlmacenamientos");
    listaA.innerHTML = "";
    config.almacenes.forEach((a, i) => {
      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";
      div.style.padding = "4px 0";
      div.innerHTML = `<span>${a}</span><button onclick="eliminarAlmacenamiento(${i})" class="danger" style="padding:2px 6px; font-size:12px;">Eliminar</button>`;
      listaA.appendChild(div);
    });
  }
  function agregarUnidad() {
    const input = document.getElementById("nuevaUnidad");
    const valor = input.value.trim();
    if (valor && !config.unidades.includes(valor)) {
      config.unidades.push(valor);
      localStorage.setItem("unidades", JSON.stringify(config.unidades));
      renderizarConfiguraciones();
      input.value = "";
      cargarSelectsConfig();
    }
  }
  function eliminarUnidad(index) {
    if (confirm("¬øEliminar esta unidad?")) {
      config.unidades.splice(index, 1);
      localStorage.setItem("unidades", JSON.stringify(config.unidades));
      renderizarConfiguraciones();
      cargarSelectsConfig();
    }
  }
  function agregarAlmacenamiento() {
    const input = document.getElementById("nuevoAlmacen");
    const valor = input.value.trim();
    if (valor && !config.almacenes.includes(valor)) {
      config.almacenes.push(valor);
      localStorage.setItem("almacenes", JSON.stringify(config.almacenes));
      renderizarConfiguraciones();
      input.value = "";
      cargarSelectsConfig();
    }
  }
  function eliminarAlmacenamiento(index) {
    if (confirm("¬øEliminar este lugar?")) {
      config.almacenes.splice(index, 1);
      localStorage.setItem("almacenes", JSON.stringify(config.almacenes));
      renderizarConfiguraciones();
      cargarSelectsConfig();
    }
  }
  function renderizarVistas() {
    renderizarTabla();
    renderizarTablaImpulsados();
    renderizarCalendario();
    renderizarBotonesAlmacenes();
  }
  function cambiarVista(vista) {
    document.querySelectorAll(".container").forEach(el => el.classList.remove("active-view"));
    document.querySelectorAll(".navbar button").forEach(btn => btn.classList.remove("active"));
    if (vista === "calendario") {
      document.getElementById("vistaCalendario").classList.add("active-view");
      document.getElementById("btnCalendario").classList.add("active");
      renderizarCalendario();
    } else if (vista === "inventario") {
      document.getElementById("vistaInventario").classList.add("active-view");
      document.getElementById("btnInventario").classList.add("active");
      cargarSelectsConfig();
      renderizarBotonesAlmacenes();
      initAutocompletado();
    } else if (vista === "impulsados") {
      document.getElementById("vistaImpulsados").classList.add("active-view");
      document.getElementById("btnImpulsados").classList.add("active");
      renderizarTablaImpulsados();
    } else if (vista === "configuraciones") {
      document.getElementById("vistaConfiguraciones").classList.add("active-view");
      document.getElementById("btnConfig").classList.add("active");
      renderizarConfiguraciones();
    }
  }

  // Inicializar
  renderizarVistas();
  cambiarVista('calendario');
</script>
</body>
</html>
